#
# Azure Pipelines for building and pushing HUGO website
#
trigger:
  - main
  - azure-pipelines

pool:
  vmImage: "ubuntu-latest"

variables:
  hugo.version: '0.80.0'

name: 1.0.$(Rev:rr).$(Date:yyyyMMdd)


jobs:
  - job: "HUGO_build"
    displayName: "[HUGO] Build static website"
    steps:
      - checkout: self
        submodules: recursive
        displayName: "[Git] Get entire source with submodules"

      - script: |
          wget -c https://github.com/gohugoio/hugo/releases/download/v$(hugo.version)/hugo_$(hugo.version)_Linux-64bit.deb
        displayName: "[Download] Get HUGO release"

      - script: 'sudo dpkg -i hugo_$(hugo.version)_Linux-64bit.deb'
        displayName: "[Install] Install HUGO package"

      - script: 'hugo --minify --enableGitInfo'
        workingDirectory: $(Build.SourcesDirectory)
        displayName: "[Build] Create static HTML site"

      - task: CopyFiles@2
        displayName: "[Copy] public â†’ Artifacts directory"
        inputs:
          SourceFolder: $(Build.SourcesDirectory)/public
          TargetFolder: $(Build.ArtifactStagingDirectory)/public

      - task: ArchiveFiles@2
        displayName: "[TAR] Compress HUGO build directory"
        inputs:
          rootFolderOrFile: $(Build.ArtifactStagingDirectory)/public
          archiveType: tar
          tarCompression: xz
          archiveFile: $(Build.ArtifactStagingDirectory)/site-$(Build.BuildNumber).txz

      - task: PublishBuildArtifacts@1
        displayName: "[Publish] Upload build directory"
        inputs:
          PathtoPublish: $(Build.ArtifactStagingDirectory)/site-$(Build.BuildNumber).txz
          ArtifactName: $(Build.BuildNumber)
          publishLocation: Container
          TargetPath: $(Build.ArtifactStagingDirectory)
